## 漏洞成因

    由于Word中的RTF分析器在解析pFragments属性值时，没有正确计算属性值所占用的空间大小，只要复制的数据大小超过0x14即可覆盖到函数返回地址，
	进而控制程序的执行流程，用于执行恶意程序。

	（这里RTF分析器在复制数据时会把每两个相邻的数字解析成一个16进制数转成对应的ascii复制进内存。例如：在rtf中是30复制进内存被解析成0。
	因此0x14个字节在rtf中要用40个垃圾字符来填充。）

## 漏洞利用

我们只需将返回地址用jmp esp指令地址覆盖，例如：

	‘a’ * 40 + （jmp esp地址）

然后将shellcode放在后面，即可执行任意代码。由于漏洞函数返回前会弹出0x14大小的栈空间，因此我们需要填充一些垃圾字符。
例如：

	‘a’*40 + （jmp esp地址） + 'a'*40 + shellcode.

![](./1.png)

## 补充：RTF文件格式

RTF是一种在不同操作系统下不同应用软件之间进行文本和图象信息交换的文件格式。以RTF格式作为多媒体系统中文本媒体的一种输入形式，可为用户提供极大的方便。

简要分析了RTF文件格式

### RTF基本语法

RTF文件由未格式化本文、控制字、控制符和组组成。RTF文件没有限制文件的行的最大长度。控制字是RTF用来标记打印控制符和管理文档信息的一种特殊格式的命令。一个控制字最长32个字符。控制字的使用格式如下:

\字母序列<分隔符>

注意：每个控制字均以一个反斜杠\开头。字母序列由a～z 的小写字母组成。控制字（或者称为关键字）通常应该不包含任何大写字母。

分隔符标记RTF控制字的结束, 可以是下列各项之一:

    ·  一个空格，这时空格是控制字的一部份。
    
    ·  一个数字或连字符(-), 表示跟随的一个数值参数。该数字序列的长度由其后的一个空格或除了字母和数字
	的其他字符划定。这个参数可以是正数或者负数，它的取值范围通常是从-32767到32767。
    
    ·  任何非字母和数字的其他字符。这种情况下，此分隔字符结束控制字，而它并不属于控制字的一部分。
    控制符由一个反斜线\跟随单个非字母字符组成。例如，\~代表一个不换行空格。控制符不需要分隔符。

组由包括在({})中的文本、控制字或控制符组成。左扩符({)表示组的开始，右扩符(})表示组的结束。每个组包括文本和文本的不同属性。RTF文件也能同时包括字体、格式、屏幕颜色、图形、脚注、注释(注解)、文件头和文件尾、摘要信息、域和书签的组合，以及文档、区段、段落和字符的格式属性。如果包括字体、文件、格式、屏幕颜色、校订标记，以及摘要信息组、文档格式属性，则他们一定要在文件的第一纯文本字符之前，这些组形成RTF的文件头。如果包括字体组,则它应该在格式组之前。如果组未使用,可以省略。

对于RTF文件的详细语法及关键字说明请参阅《Rich Text Format (RTF) Specification v1.7》，这里不作更详细的说明。

### Hello Word

一个Hello Word!演示例子，内容如下：

    {\rtf1\ansi\ansicpg936\deff0\deflang1033\deflangfe2052
    {\fonttbl{\f0\fmodern\fprq6\fcharset134 \'cb\'ce\'cc\'e5;}}
    {\*\generator Msftedit 5.41.21.2500;}\viewkind4\uc1\pard\lang2052\f0\fs20 Hello World!\par}
    
该文件分析如下：

    1、文件基本属性：
    {\rtf1 RTF版本\ansi字符集\ansicpg936简体中文\deff0默认字体0\deflang1033美国英语\deflangfe2052中国汉语
    2、字体表：
    {\fonttbl{\f0字体0\fmodern\fprq6字体间距为6\fcharset134GB2312国标码 \'cb\'ce\'cc\'e5宋体;}}
    3、生成器信息：
    {\*\generator Msftedit 5.41.21.2500;}
    4、文档属性：
    \viewkind4正常视图\uc1单字节\pard默认段落属性\lang2052中国汉语\f0字体0\fs20字体大小20磅
    5、正文文本：
    Hello World!\par段落标记
    }文件结束


## 参考链接

	http://interglacial.com/rtf/

